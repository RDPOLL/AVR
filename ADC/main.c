#include <stdlib.h>
#include <stdio.h>
#include <avr/io.h>
#include <avr/interrupt.h>
#include "lcd.h"
#include "serial.c"
#include "rotary.c"
#include "adc.c"

#define F_CPU    	16000000

/*
* Die NTC Tabelle, bestehend aus 1024 Temperaturstützpunkten.
* Einheit:0.1 °C
*/
short NTC_table[1024] = {
  -879, -836, -793, -761, -736, -714, -696, 
  -680, -665, -652, -640, -628, -618, -608, 
  -599, -590, -582, -574, -567, -560, -553, 
  -546, -540, -534, -528, -523, -517, -512, 
  -507, -502, -497, -492, -487, -483, -478, 
  -474, -470, -466, -462, -458, -454, -450, 
  -447, -443, -439, -436, -432, -429, -426, 
  -422, -419, -416, -413, -410, -407, -404, 
  -401, -398, -395, -392, -390, -387, -384, 
  -381, -379, -376, -374, -371, -368, -366, 
  -364, -361, -359, -356, -354, -352, -349, 
  -347, -345, -342, -340, -338, -336, -334, 
  -331, -329, -327, -325, -323, -321, -319, 
  -317, -315, -313, -311, -309, -307, -305, 
  -303, -301, -299, -298, -296, -294, -292, 
  -290, -288, -287, -285, -283, -281, -280, 
  -278, -276, -274, -273, -271, -269, -268, 
  -266, -264, -263, -261, -259, -258, -256, 
  -255, -253, -251, -250, -248, -247, -245, 
  -244, -242, -240, -239, -237, -236, -234, 
  -233, -231, -230, -229, -227, -226, -224, 
  -223, -221, -220, -218, -217, -216, -214, 
  -213, -211, -210, -209, -207, -206, -205, 
  -203, -202, -200, -199, -198, -196, -195, 
  -194, -193, -191, -190, -189, -187, -186, 
  -185, -183, -182, -181, -180, -178, -177, 
  -176, -175, -173, -172, -171, -170, -168, 
  -167, -166, -165, -163, -162, -161, -160, 
  -159, -157, -156, -155, -154, -153, -151, 
  -150, -149, -148, -147, -146, -144, -143, 
  -142, -141, -140, -139, -137, -136, -135, 
  -134, -133, -132, -131, -129, -128, -127, 
  -126, -125, -124, -123, -122, -121, -119, 
  -118, -117, -116, -115, -114, -113, -112, 
  -111, -110, -108, -107, -106, -105, -104, 
  -103, -102, -101, -100, -99, -98, -97, -96, 
  -95, -94, -93, -91, -90, -89, -88, -87, -86, 
  -85, -84, -83, -82, -81, -80, -79, -78, -77, 
  -76, -75, -74, -73, -72, -71, -70, -69, -68, 
  -67, -66, -65, -64, -63, -62, -61, -60, -59, 
  -58, -57, -56, -55, -54, -53, -52, -51, -50, 
  -49, -48, -47, -46, -45, -44, -43, -42, -41, 
  -40, -39, -38, -37, -36, -35, -34, -33, -32, 
  -31, -30, -29, -28, -28, -27, -26, -25, -24, 
  -23, -22, -21, -20, -19, -18, -17, -16, -15, 
  -14, -13, -12, -11, -10, -9, -8, -8, -7, 
  -6, -5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 
  6, 7, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 
  17, 18, 19, 20, 20, 21, 22, 23, 24, 25, 26, 
  27, 28, 29, 30, 31, 32, 32, 33, 34, 35, 36, 
  37, 38, 39, 40, 41, 42, 43, 43, 44, 45, 46, 
  47, 48, 49, 50, 51, 52, 53, 54, 54, 55, 56, 
  57, 58, 59, 60, 61, 62, 63, 64, 65, 65, 66, 
  67, 68, 69, 70, 71, 72, 73, 74, 75, 75, 76, 
  77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 86, 
  87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 96, 
  97, 98, 99, 100, 101, 102, 103, 104, 105, 
  106, 107, 107, 108, 109, 110, 111, 112, 113, 
  114, 115, 116, 117, 118, 119, 119, 120, 121, 
  122, 123, 124, 125, 126, 127, 128, 129, 130, 
  131, 131, 132, 133, 134, 135, 136, 137, 138, 
  139, 140, 141, 142, 143, 144, 145, 145, 146, 
  147, 148, 149, 150, 151, 152, 153, 154, 155, 
  156, 157, 158, 159, 160, 161, 161, 162, 163, 
  164, 165, 166, 167, 168, 169, 170, 171, 172, 
  173, 174, 175, 176, 177, 178, 179, 180, 181, 
  182, 182, 183, 184, 185, 186, 187, 188, 189, 
  190, 191, 192, 193, 194, 195, 196, 197, 198, 
  199, 200, 201, 202, 203, 204, 205, 206, 207, 
  208, 209, 210, 211, 212, 213, 214, 215, 216, 
  217, 218, 219, 220, 221, 222, 223, 224, 225, 
  226, 227, 228, 229, 230, 231, 232, 233, 234, 
  235, 236, 237, 238, 239, 240, 241, 242, 243, 
  244, 245, 246, 247, 249, 250, 251, 252, 253, 
  254, 255, 256, 257, 258, 259, 260, 261, 262, 
  263, 264, 265, 267, 268, 269, 270, 271, 272, 
  273, 274, 275, 276, 277, 278, 280, 281, 282, 
  283, 284, 285, 286, 287, 288, 289, 291, 292, 
  293, 294, 295, 296, 297, 298, 300, 301, 302, 
  303, 304, 305, 306, 308, 309, 310, 311, 312, 
  313, 315, 316, 317, 318, 319, 320, 322, 323, 
  324, 325, 326, 327, 329, 330, 331, 332, 333, 
  335, 336, 337, 338, 340, 341, 342, 343, 344, 
  346, 347, 348, 349, 351, 352, 353, 354, 356, 
  357, 358, 359, 361, 362, 363, 365, 366, 367, 
  368, 370, 371, 372, 374, 375, 376, 378, 379, 
  380, 382, 383, 384, 386, 387, 388, 390, 391, 
  392, 394, 395, 396, 398, 399, 401, 402, 403, 
  405, 406, 408, 409, 410, 412, 413, 415, 416, 
  418, 419, 420, 422, 423, 425, 426, 428, 429, 
  431, 432, 434, 435, 437, 438, 440, 441, 443, 
  444, 446, 447, 449, 450, 452, 454, 455, 457, 
  458, 460, 461, 463, 465, 466, 468, 470, 471, 
  473, 474, 476, 478, 479, 481, 483, 484, 486, 
  488, 490, 491, 493, 495, 496, 498, 500, 502, 
  503, 505, 507, 509, 511, 512, 514, 516, 518, 
  520, 522, 523, 525, 527, 529, 531, 533, 535, 
  537, 539, 541, 543, 545, 546, 548, 550, 552, 
  554, 557, 559, 561, 563, 565, 567, 569, 571, 
  573, 575, 577, 580, 582, 584, 586, 588, 590, 
  593, 595, 597, 599, 602, 604, 606, 609, 611, 
  613, 616, 618, 621, 623, 625, 628, 630, 633, 
  635, 638, 640, 643, 645, 648, 651, 653, 656, 
  659, 661, 664, 667, 669, 672, 675, 678, 681, 
  683, 686, 689, 692, 695, 698, 701, 704, 707, 
  710, 713, 716, 720, 723, 726, 729, 732, 736, 
  739, 742, 746, 749, 753, 756, 760, 763, 767, 
  770, 774, 778, 782, 785, 789, 793, 797, 801, 
  805, 809, 813, 817, 821, 825, 830, 834, 838, 
  843, 847, 852, 857, 861, 866, 871, 876, 880, 
  885, 890, 896, 901, 906, 911, 917, 922, 928, 
  934, 939, 945, 951, 957, 964, 970, 976, 983, 
  989, 996, 1003, 1010, 1017, 1024, 1032, 1039, 
  1047, 1055, 1063, 1071, 1080, 1088, 1097, 
  1106, 1115, 1125, 1135, 1145, 1155, 1165, 
  1176, 1187, 1199, 1211, 1223, 1235, 1248, 
  1262, 1276, 1290, 1305, 1320, 1337, 1353, 
  1371, 1389, 1408, 1428, 1449, 1471, 1495, 
  1520, 1546, 1574, 1603, 1635, 1670, 1707, 
  1747, 1791, 1839, 1893, 1954, 2022, 2101, 
  2194, 2305, 2443, 2623, 2874, 3270, 4092, 
  4914
};
 
short NTC_ADC2Temperature(unsigned short adc_value){
 
  /* Werte direkt aus der Tabelle lesen. */
  return NTC_table[adc_value];
};


//------------------------------MAIN------------------------------------
int main(void)
{
    DDRD = 0x00;			//Schalterport
    DDRB = 0Xff;			//LEDport
    DDRC = 0xff;			//LCDdaten
    DDRA = 0xF0;			//LCDctrl

    enum
    {
	Startscreen,
	Tempmeasure,
	Lightmeasure
    };

    char output[16];
    unsigned char Status = Startscreen;
    unsigned short ldr = 0;
    unsigned short ntc = 0;
    unsigned short temp = 0;
    unsigned char tempKoma = 0;
    //volatile unsigned long i = 0;

    ADC_init(0x0F);
    lcd_init(LCD_DISP_ON);  //Initialisieren

    while(1)
    {
		usrInput(PIND);
		
		ldr = read_ADC(0);
		ntc = read_ADC(1);

		switch(Status)
		{
			case Startscreen:
			lcd_gotoxy(1, 0);
			lcd_puts("SIMPLE WEATHER");
			
			if(rotary.press)
			{
			  Status = Tempmeasure;
			  lcd_clrscr();
			}
			
			break;

			case Tempmeasure:
			temp = NTC_ADC2Temperature(ntc);
			tempKoma = temp % 10;
			temp /= 10;

			sprintf(output, "Temp: %03d,%dC", temp, tempKoma);
			lcd_gotoxy(0, 0);
			lcd_puts(output);

			if(rotary.right)
			{
			  Status = Lightmeasure;
			  lcd_clrscr();
			}
			
			break;

			case Lightmeasure:
			sprintf(output, "Light: %04dADC", ldr);
			lcd_gotoxy(0, 0);
			lcd_puts(output);

			if(rotary.left)
			{
			  Status = Tempmeasure;
			  lcd_clrscr();
			}
			
			break;
		}
    }//end of while
}//end of main
